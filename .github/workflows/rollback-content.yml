name: Rollback Content

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "production or staging"
        required: true
        type: choice
        options:
          - production
          - staging
        default: production
      release_id:
        description: "release_id from Publish Content"
        required: true
      region:
        required: true
        default: "CN_MAINLAND"
      locale:
        required: true
        default: "zh-CN"
      dir_alias:
        required: true
        default: "MBTI-CN-v0.2.1-TEST"
      probe:
        description: "true/false"
        required: true
        type: choice
        options:
          - "true"
          - "false"
        default: "true"

concurrency:
  group: rollback-content-${{ inputs.target_env }}
  cancel-in-progress: false

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_env }}

    steps:
      - name: Rollback via API
        env:
          BASE_URL: ${{ secrets.CONTENT_PUBLISH_BASE_URL }}
          ADMIN_TOKEN: ${{ secrets.FAP_ADMIN_TOKEN }}
          RELEASE_ID: ${{ inputs.release_id }}
          REGION: ${{ inputs.region }}
          LOCALE: ${{ inputs.locale }}
          DIR_ALIAS: ${{ inputs.dir_alias }}
          PROBE: ${{ inputs.probe }}
        shell: bash
        run: |
          set -euo pipefail

          trim() { echo -n "$1" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//'; }

          BASE_URL="$(trim "$BASE_URL")"
          RELEASE_ID="$(trim "$RELEASE_ID")"
          REGION="$(trim "$REGION")"
          LOCALE="$(trim "$LOCALE")"
          DIR_ALIAS="$(trim "$DIR_ALIAS")"
          PROBE="$(trim "$PROBE")"

          case "$PROBE" in
            true|false) ;;
            *) echo "::error::probe must be true/false, got: $PROBE"; exit 1;;
          esac

          PAYLOAD="$(RELEASE_ID="$RELEASE_ID" REGION="$REGION" LOCALE="$LOCALE" DIR_ALIAS="$DIR_ALIAS" PROBE="$PROBE" php -r '
$payload = [
  "release_id" => getenv("RELEASE_ID") ?: "",
  "region" => getenv("REGION") ?: "",
  "locale" => getenv("LOCALE") ?: "",
  "dir_alias" => getenv("DIR_ALIAS") ?: "",
  "probe" => (getenv("PROBE") === "true"),
];
echo json_encode($payload, JSON_UNESCAPED_UNICODE);
'
          )"

          echo "Payload=$PAYLOAD"

          RESP="$(curl -sS -X POST "$BASE_URL/api/v0.2/admin/content-releases/rollback" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -H "X-Admin-Token: ${ADMIN_TOKEN}" \
            -d "$PAYLOAD")"

          echo "$RESP" | php -r '$j=json_decode(stream_get_contents(STDIN), true); echo json_encode($j, JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES).PHP_EOL;'

          OK="$(echo "$RESP" | php -r '$j=json_decode(stream_get_contents(STDIN), true); if (!is_array($j) || !array_key_exists("ok", $j)) { echo ""; exit; } echo $j["ok"] ? "true" : "false";')"
          STATUS="$(echo "$RESP" | php -r '$j=json_decode(stream_get_contents(STDIN), true); echo $j["status"] ?? "";')"
          MSG="$(echo "$RESP" | php -r '$j=json_decode(stream_get_contents(STDIN), true); echo $j["message"] ?? "";')"
          ERR="$(echo "$RESP" | php -r '$j=json_decode(stream_get_contents(STDIN), true); echo $j["error"] ?? "";')"

          if [[ "$OK" != "true" ]]; then
            echo "::error::rollback api call failed ok=$OK error=$ERR message=$MSG"
            exit 1
          fi

          if [[ "$STATUS" != "success" ]]; then
            echo "::error::rollback failed status=$STATUS error=$ERR message=$MSG"
            exit 1
          fi

          NEW_RELEASE_ID="$(echo "$RESP" | php -r '$j=json_decode(stream_get_contents(STDIN), true); echo $j["release_id"] ?? "";')"
          RB_VERSION_ID="$(echo "$RESP" | php -r '$j=json_decode(stream_get_contents(STDIN), true); echo $j["rolled_back_to"]["version_id"] ?? "";')"
          RB_PACK_ID="$(echo "$RESP" | php -r '$j=json_decode(stream_get_contents(STDIN), true); echo $j["rolled_back_to"]["pack_id"] ?? "";')"

          echo "rolled_back_release_id=$NEW_RELEASE_ID" >> "$GITHUB_OUTPUT"
          echo "rolled_back_version_id=$RB_VERSION_ID" >> "$GITHUB_OUTPUT"
          echo "rolled_back_pack_id=$RB_PACK_ID" >> "$GITHUB_OUTPUT"

      - name: Post-rollback probes (public)
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS "https://fermatmind.com/api/v0.2/health" | php -r '$j=json_decode(stream_get_contents(STDIN), true); exit(($j["ok"] ?? false) ? 0 : 1);' >/dev/null
          curl -fsS "https://fermatmind.com/api/v0.2/scales/MBTI/questions?region=CN_MAINLAND&locale=zh-CN" | php -r '$j=json_decode(stream_get_contents(STDIN), true); exit(($j["ok"] ?? false) ? 0 : 1);' >/dev/null
          curl -fsS "https://fermatmind.com/api/v0.2/content-packs" | php -r '$j=json_decode(stream_get_contents(STDIN), true); exit(($j["ok"] ?? false) ? 0 : 1);' >/dev/null
