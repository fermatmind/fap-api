name: Deploy Application

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      env:
        description: "deploy target"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.repository }}-${{ github.event_name == 'workflow_dispatch' && inputs.env || 'staging' }}
  cancel-in-progress: ${{ github.event_name == 'push' }}  # push(main) 只跑最新一次 staging

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy (${{ github.event_name == 'workflow_dispatch' && inputs.env || 'staging' }})
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # 关键：绑定 GitHub Environment，使 secrets.SSH_PRIVATE_KEY 读取到对应环境的 Environment Secret
    environment:
      name: ${{ github.event_name == 'workflow_dispatch' && inputs.env || 'staging' }}

    env:
      TARGET: ${{ github.event_name == 'workflow_dispatch' && inputs.env || 'staging' }}
      DEPLOYER_VERSION: "7.5.12"

      # ====== production ======
      DEPLOY_USER_PROD: "ubuntu"
      DEPLOY_PORT_PROD: "22"
      DEPLOY_HOST_PROD: "122.152.221.126"
      DEPLOY_PATH_PROD: "/var/www/fap-api"
      HEALTHCHECK_URL_PROD: "https://fermatmind.com/api/v0.2/healthz"

      # ====== staging ======
      DEPLOY_USER_STG: "ubuntu"
      DEPLOY_PORT_STG: "22"
      DEPLOY_HOST_STG: "49.234.55.28"
      DEPLOY_PATH_STG: "/var/www/fap-api-staging"
      HEALTHCHECK_URL_STG: "https://staging.fermatmind.com/api/v0.2/healthz"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Resolve target vars
        shell: bash
        run: |
          set -euo pipefail

          case "$TARGET" in
            production)
              DEPLOY_HOST="$DEPLOY_HOST_PROD"
              DEPLOY_USER="$DEPLOY_USER_PROD"
              DEPLOY_PORT="$DEPLOY_PORT_PROD"
              DEPLOY_PATH="$DEPLOY_PATH_PROD"
              HEALTHCHECK_URL="$HEALTHCHECK_URL_PROD"
              ;;
            staging)
              DEPLOY_HOST="$DEPLOY_HOST_STG"
              DEPLOY_USER="$DEPLOY_USER_STG"
              DEPLOY_PORT="$DEPLOY_PORT_STG"
              DEPLOY_PATH="$DEPLOY_PATH_STG"
              HEALTHCHECK_URL="$HEALTHCHECK_URL_STG"
              ;;
            *)
              echo "invalid TARGET=$TARGET"
              exit 2
              ;;
          esac

          {
            echo "DEPLOY_HOST=$DEPLOY_HOST"
            echo "DEPLOY_USER=$DEPLOY_USER"
            echo "DEPLOY_PORT=$DEPLOY_PORT"
            echo "DEPLOY_PATH=$DEPLOY_PATH"
            echo "HEALTHCHECK_URL=$HEALTHCHECK_URL"
          } >> "$GITHUB_ENV"

          echo "TARGET=$TARGET"
          echo "SSH=$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PORT"
          echo "DEPLOY_PATH=$DEPLOY_PATH"
          echo "HEALTHCHECK_URL=$HEALTHCHECK_URL"

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Debug SSH agent (fingerprints only)
        shell: bash
        run: |
          set -euo pipefail
          ssh-add -l

      - name: Add target host to known_hosts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan -p "$DEPLOY_PORT" -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: SSH preflight (whoami)
        shell: bash
        run: |
          set -euo pipefail

          # ✅ 已删除 -o IdentitiesOnly=yes，确保使用 ssh-agent 中的 key
          ssh -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=10 \
            -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" \
            'whoami; hostname; id'

          ssh -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=10 \
            -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" \
            "test -d '$DEPLOY_PATH' && echo deploy_path_ok"

      - name: Install Deployer (pinned)
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL -o /tmp/dep.phar "https://github.com/deployphp/deployer/releases/download/v${DEPLOYER_VERSION}/deployer.phar"
          php /tmp/dep.phar --version

      - name: Deploy (Deployer)
        shell: bash
        env:
          DEPLOYER_NO_INTERACTION: "1"
        run: |
          set -euo pipefail
          php /tmp/dep.phar deploy "$TARGET" -f deploy.php -vvv --no-interaction

      - name: Healthcheck (post deploy)
        shell: bash
        run: |
          set -euo pipefail
          echo "Healthcheck: $HEALTHCHECK_URL"
          for i in 1 2 3 4 5 6 7 8 9 10; do
            OUT="$(curl -fsS --max-time 10 "$HEALTHCHECK_URL" || true)"
            echo "$OUT" | grep -q '"ok":true' && exit 0
            sleep 3
          done
          echo "Healthcheck failed"
          exit 1
