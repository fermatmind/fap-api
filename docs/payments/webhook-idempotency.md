# 支付回调幂等与重放（webhook idempotency）

## 定义
- `provider_event_id`：支付平台事件唯一标识，系统内必须唯一。
- 幂等键：`provider_event_id` 或 `provider_event_id + order_id` 作为唯一键。
- 重放安全：同一事件重复投递时，处理结果保持不变且可返回成功响应。

## 规则
1) 幂等处理（写死）
- 同一 `provider_event_id` 只能写入一次；重复事件直接返回 200，并读取既有结果。
- 同一订单在相同事件下的状态/权益不可重复变更。

2) 验签策略（写死）
- 验签失败：必须记录请求摘要与失败原因并告警；不得改变订单状态。
- 验签成功：方可进入状态机与权益处理流程。

3) 重试/重复/乱序（写死）
- 重复回调：返回 200 + 幂等结果，不二次处理。
- 平台重试：按幂等处理，确保可重放安全。
- 乱序回调：进入异常队列/拒绝处理，明确记录，不得静默吞掉。

4) 审计字段建议（写死建议口径）
- `payment_events` 记录字段建议：
  - `provider_event_id`
  - `order_id`
  - `payload`（原始请求体）
  - `headers_hash`（请求头摘要）
  - `request_id`（内部跟踪）
  - `signature_verified`（验签结果）
  - `handled_result`（处理结果）
  - `created_at` / `handled_at`

## 示例
- 同一回调重放 3 次：第一次写入事件并推进状态；后两次直接返回 200，不重复发放。
- 验签失败：记录事件摘要与失败原因，订单保持原状态。

## 异常处理
- `provider_event_id` 冲突：拒绝写入并告警。
- 乱序事件：入异常队列，需人工或补偿任务重新评估。

## 验收
- 重放/重复回调不产生重复权益或重复状态写入。
- 验签失败回调不会改变订单状态。
- 审计记录可完整重放与追踪处理链路。
