name: selfcheck

on:
  pull_request:
  push:

jobs:
  selfcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer:v2

      - name: Install backend deps
        working-directory: backend
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Run selfcheck (default manifest)
        working-directory: backend
        run: php artisan fap:self-check --strict-assets

      - name: Prepare Laravel env (testing)
        working-directory: backend
        run: |
          cp -n .env.example .env || true
          php artisan key:generate --force

      - name: Prepare sqlite
        working-directory: backend
        run: |
          mkdir -p database
          touch database/database.sqlite

      - name: Migrate
        working-directory: backend
        env:
          APP_ENV: testing
          DB_CONNECTION: sqlite
          DB_DATABASE: ${{ github.workspace }}/backend/database/database.sqlite
        run: php artisan migrate --force

      - name: Seed demo attempt+result (for runtime validate)
        working-directory: backend
        env:
          APP_ENV: testing
          DB_CONNECTION: sqlite
          DB_DATABASE: ${{ github.workspace }}/backend/database/database.sqlite
        run: |
          set -euo pipefail

          OUT="$(php artisan tinker --execute='
          use Illuminate\Support\Str;
          use App\Models\Attempt;
          use App\Models\Result;

          $attemptId = (string) Str::uuid();
          $anonId = "ci_" . Str::uuid();

          $a = new Attempt();
          $a->id = $attemptId;
          $a->anon_id = $anonId;            
          $a->region = "CN_MAINLAND";
          $a->locale = "zh-CN";

          // （建议）把这些也补上，避免 pack/规则解析不到导致 cards=0
          if (property_exists($a, "scale_code")) $a->scale_code = "MBTI";
          if (property_exists($a, "scale_version")) $a->scale_version = "v0.2.1-TEST";
          if (property_exists($a, "question_count")) $a->question_count = 144;

          $a->save();

          $r = new Result();
          $r->attempt_id = $attemptId;
          if (property_exists($r, "anon_id")) $r->anon_id = $anonId;
          $r->scale_code = "MBTI";
          if (property_exists($r, "scale_version")) $r->scale_version = "v0.2.1-TEST";
          $r->type_code = "ESTJ-A";
          $r->profile_version = "mbti32-v2.5";
          $r->content_package_version = "v0.2.1-TEST";
          $r->scores_pct = ["EI"=>55,"SN"=>45,"TF"=>60,"JP"=>52,"AT"=>58];
          $r->axis_states = ["EI"=>"moderate","SN"=>"moderate","TF"=>"moderate","JP"=>"moderate","AT"=>"moderate"];
          $r->save();

          echo "ATTEMPT_ID=".$attemptId.PHP_EOL;
          ' 2>&1)"

          echo "$OUT"

          ATTEMPT_ID="$(echo "$OUT" | tr -d '\r' | grep -Eo '[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}' | head -n 1)"
          [ -n "$ATTEMPT_ID" ] || (echo "ERROR: failed to extract attempt_id" && exit 1)

          echo "FAP_VALIDATE_ATTEMPT_ID=$ATTEMPT_ID" >> "$GITHUB_ENV"
          echo "Seeded attempt_id=$ATTEMPT_ID"

      - name: Runtime validate report
        working-directory: backend
        env:
          APP_ENV: testing
          DB_CONNECTION: sqlite
          DB_DATABASE: ${{ github.workspace }}/backend/database/database.sqlite
        run: php artisan fap:validate-report --attempt="$FAP_VALIDATE_ATTEMPT_ID"
