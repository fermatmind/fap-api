name: Deploy Application

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      env:
        description: "deploy target"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.repository }}-${{ github.event_name == 'workflow_dispatch' && inputs.env || 'staging' }}
  cancel-in-progress: ${{ github.event_name == 'push' }} # push(main) 只保留最新一次 staging

permissions:
  contents: read

jobs:
  deploy:
    # ⭐⭐⭐ 关键：绑定 GitHub Environment（触发审批 & 使用环境 secrets）
    environment:
      name: ${{ github.event_name == 'workflow_dispatch' && inputs.env || 'staging' }}

    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      TARGET: ${{ github.event_name == 'workflow_dispatch' && inputs.env || 'staging' }}
      DEPLOYER_VERSION: "7.5.12"

      # ====== production ======
      DEPLOY_USER_PROD: "ubuntu"
      DEPLOY_PORT_PROD: "22"
      DEPLOY_HOST_PROD: "122.152.221.126"
      DEPLOY_PATH_PROD: "/var/www/fap-api"
      HEALTHCHECK_URL_PROD: "https://fermatmind.com/api/v0.2/healthz"

      # ====== staging ======
      DEPLOY_USER_STG: "ubuntu"
      DEPLOY_PORT_STG: "22"
      DEPLOY_HOST_STG: "49.234.55.28"
      DEPLOY_PATH_STG: "/var/www/fap-api-staging"
      HEALTHCHECK_URL_STG: "https://staging.fermatmind.com/api/v0.2/healthz"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Resolve target vars
        run: |
          set -euo pipefail
          case "$TARGET" in
            production)
              echo "DEPLOY_HOST=$DEPLOY_HOST_PROD" >> $GITHUB_ENV
              echo "DEPLOY_USER=$DEPLOY_USER_PROD" >> $GITHUB_ENV
              echo "DEPLOY_PORT=$DEPLOY_PORT_PROD" >> $GITHUB_ENV
              echo "DEPLOY_PATH=$DEPLOY_PATH_PROD" >> $GITHUB_ENV
              echo "HEALTHCHECK_URL=$HEALTHCHECK_URL_PROD" >> $GITHUB_ENV
              ;;
            staging)
              echo "DEPLOY_HOST=$DEPLOY_HOST_STG" >> $GITHUB_ENV
              echo "DEPLOY_USER=$DEPLOY_USER_STG" >> $GITHUB_ENV
              echo "DEPLOY_PORT=$DEPLOY_PORT_STG" >> $GITHUB_ENV
              echo "DEPLOY_PATH=$DEPLOY_PATH_STG" >> $GITHUB_ENV
              echo "HEALTHCHECK_URL=$HEALTHCHECK_URL_STG" >> $GITHUB_ENV
              ;;
            *)
              echo "invalid TARGET=$TARGET"
              exit 2
              ;;
          esac
          echo "TARGET=$TARGET"
          echo "SSH=$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PORT"
          echo "PATH=$DEPLOY_PATH"
          echo "HEALTHCHECK_URL=$HEALTHCHECK_URL"

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add target host to known_hosts
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan -p "$DEPLOY_PORT" -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: SSH preflight (whoami)
        run: |
          set -euo pipefail
          ssh -o BatchMode=yes -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=10 \
            -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" \
            'whoami; hostname; id; test -d '"$DEPLOY_PATH"' && echo "deploy_path ok"'

      - name: Install Deployer (pinned)
        run: |
          set -euo pipefail
          curl -fsSL -o /tmp/dep.phar \
            "https://github.com/deployphp/deployer/releases/download/v${DEPLOYER_VERSION}/deployer.phar"
          php /tmp/dep.phar --version

      - name: Deploy (Deployer)
        env:
          DEPLOYER_NO_INTERACTION: "1"
        run: |
          set -euo pipefail
          php /tmp/dep.phar deploy "$TARGET" -f deploy.php -vvv --no-interaction

      - name: Healthcheck (post deploy)
        run: |
          set -euo pipefail
          echo "Healthcheck: $HEALTHCHECK_URL"
          for i in 1 2 3 4 5 6 7 8 9 10; do
            OUT="$(curl -fsS --max-time 10 "$HEALTHCHECK_URL" || true)"
            echo "$OUT" | grep -q '"ok":true' && exit 0
            sleep 3
          done
          echo "Healthcheck failed"
          exit 1
