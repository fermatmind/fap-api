name: CI DLQ Replay Metrics

on:
  workflow_dispatch:
  push:
    branches: ["**"]
  pull_request:

jobs:
  dlq-replay-metrics:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      APP_ENV: ci
      APP_DEBUG: "true"
      DB_CONNECTION: sqlite
      DB_DATABASE: /tmp/fap-dlq-ci.sqlite
      QUEUE_CONNECTION: database
      FAP_PACKS_DRIVER: local
      FAP_PACKS_ROOT: ${{ github.workspace }}/content_packages
      FAP_DEFAULT_REGION: CN_MAINLAND
      FAP_DEFAULT_LOCALE: zh-CN
      FAP_DEFAULT_PACK_ID: MBTI.cn-mainland.zh-CN.v0.2.2
      FAP_DEFAULT_DIR_VERSION: MBTI-CN-v0.2.2
      FAP_ADMIN_TOKEN: pr54-ci-admin-token

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: CAE gate (config + artifact safety)
        run: bash backend/scripts/cae_gate.sh

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          coverage: none
          tools: composer:v2
          extensions: >
            mbstring, intl, curl, json, openssl, fileinfo, pdo, pdo_sqlite, sqlite3

      - name: Prepare Laravel cache dirs
        working-directory: backend
        run: |
          mkdir -p storage/framework/cache/data
          mkdir -p storage/framework/views
          mkdir -p storage/framework/sessions
          mkdir -p storage/logs
          mkdir -p bootstrap/cache
          chmod -R ug+rwX storage bootstrap/cache || true

      - name: Install backend dependencies
        working-directory: backend
        run: |
          composer install --no-interaction --prefer-dist --no-progress

      - name: Composer validate & audit
        working-directory: backend
        run: |
          set -euo pipefail
          composer validate --strict
          for attempt in 1 2 3; do
            if composer audit --no-interaction; then
              break
            fi

            if [[ "$attempt" -eq 3 ]]; then
              echo "::error::composer audit failed after 3 attempts"
              exit 1
            fi

            sleep $((attempt * 5))
          done

      - name: Prepare sqlite and seed defaults
        working-directory: backend
        env:
          DB_DATABASE: /tmp/fap-dlq-ci.sqlite
        run: |
          bash scripts/ci/prepare_sqlite.sh
          php artisan fap:scales:seed-default
          php artisan fap:scales:sync-slugs

      - name: Verify legacy DLQ routes are retired
        working-directory: backend
        run: |
          if php artisan route:list | grep -E "queue/dlq/metrics|queue/dlq/replay"; then
            echo "::error::legacy DLQ routes still exposed"
            exit 1
          fi

      - name: Run security guardrails regression
        working-directory: backend
        run: |
          php artisan test tests/Unit/Security/SecurityGuardrailsTest.php
