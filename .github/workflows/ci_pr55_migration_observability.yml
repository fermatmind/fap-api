name: CI PR55 Migration Observability

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: ["**"]

jobs:
  pr55-migration-observability:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      APP_ENV: ci
      APP_DEBUG: "true"
      DB_CONNECTION: sqlite
      DB_DATABASE: /tmp/fap-pr55-ci.sqlite
      QUEUE_CONNECTION: database
      FAP_PACKS_DRIVER: local
      FAP_PACKS_ROOT: ${{ github.workspace }}/content_packages
      FAP_DEFAULT_REGION: CN_MAINLAND
      FAP_DEFAULT_LOCALE: zh-CN
      FAP_DEFAULT_PACK_ID: MBTI.cn-mainland.zh-CN.v0.2.2
      FAP_DEFAULT_DIR_VERSION: MBTI-CN-v0.2.2
      FAP_ADMIN_TOKEN: pr55-ci-admin-token

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          coverage: none
          tools: composer:v2
          extensions: >
            mbstring, intl, curl, json, openssl, fileinfo, pdo, pdo_sqlite, sqlite3

      - name: Prepare Laravel cache dirs
        working-directory: backend
        run: |
          mkdir -p storage/framework/cache/data
          mkdir -p storage/framework/views
          mkdir -p storage/framework/sessions
          mkdir -p storage/logs
          mkdir -p bootstrap/cache
          chmod -R ug+rwX storage bootstrap/cache || true

      - name: Install backend dependencies
        working-directory: backend
        run: |
          composer install --no-interaction --prefer-dist --no-progress

      - name: Prepare sqlite and seed defaults
        working-directory: backend
        env:
          DB_DATABASE: /tmp/fap-pr55-ci.sqlite
        run: |
          bash scripts/ci/prepare_sqlite.sh
          php artisan fap:scales:seed-default
          php artisan fap:scales:sync-slugs

      - name: Verify migration observability routes
        working-directory: backend
        run: |
          php artisan route:list | grep -E "migrations/observability|migrations/rollback-preview"

      - name: Run migration observability tests
        working-directory: backend
        run: |
          php artisan test --filter AdminMigrationObservabilityTest
          php artisan test --filter SchemaIndexTest

      - name: Run PR55 acceptance script
        run: |
          bash backend/scripts/pr55_accept.sh
