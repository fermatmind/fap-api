name: Rollback Content

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "production or staging"
        required: true
        type: choice
        options:
          - production
          - staging
        default: production
      release_id:
        description: "release_id from Publish Content"
        required: true
        type: string
      region:
        description: "Content region"
        required: true
        type: string
        default: "CN_MAINLAND"
      locale:
        description: "Content locale"
        required: true
        type: string
        default: "zh-CN"
      dir_alias:
        description: "Dir alias to rollback"
        required: true
        type: string
        default: "MBTI-CN-v0.2.1-TEST"
      probe:
        description: "true/false"
        required: true
        type: choice
        options:
          - "true"
          - "false"
        default: "true"

concurrency:
  group: rollback-content-${{ github.repository }}-${{ inputs.target_env }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  rollback:
    name: Rollback Content (${{ inputs.target_env }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ inputs.target_env }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: CAE gate (config + artifact safety)
        run: bash backend/scripts/cae_gate.sh

      - name: Rollback via API
        id: rollback
        env:
          BASE_URL: ${{ secrets.CONTENT_PUBLISH_BASE_URL }}
          ADMIN_TOKEN: ${{ secrets.FAP_ADMIN_TOKEN }}
          RELEASE_ID: ${{ inputs.release_id }}
          REGION: ${{ inputs.region }}
          LOCALE: ${{ inputs.locale }}
          DIR_ALIAS: ${{ inputs.dir_alias }}
          PROBE: ${{ inputs.probe }}
        shell: bash
        run: |
          set -euo pipefail

          trim() { echo -n "$1" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//'; }

          BASE_URL="$(trim "${BASE_URL:-}")"
          ADMIN_TOKEN="$(trim "${ADMIN_TOKEN:-}")"
          RELEASE_ID="$(trim "${RELEASE_ID:-}")"
          REGION="$(trim "${REGION:-}")"
          LOCALE="$(trim "${LOCALE:-}")"
          DIR_ALIAS="$(trim "${DIR_ALIAS:-}")"
          PROBE="$(trim "${PROBE:-}")"

          BASE_URL="${BASE_URL%/}"

          [[ -n "$BASE_URL" ]] || { echo "::error::CONTENT_PUBLISH_BASE_URL is empty"; exit 1; }
          [[ -n "$ADMIN_TOKEN" ]] || { echo "::error::FAP_ADMIN_TOKEN is empty"; exit 1; }
          [[ -n "$RELEASE_ID" ]] || { echo "::error::release_id is empty"; exit 1; }
          [[ -n "$REGION" ]] || { echo "::error::region is empty"; exit 1; }
          [[ -n "$LOCALE" ]] || { echo "::error::locale is empty"; exit 1; }
          [[ -n "$DIR_ALIAS" ]] || { echo "::error::dir_alias is empty"; exit 1; }

          case "$PROBE" in
            true|false) ;;
            *) echo "::error::probe must be true/false, got: $PROBE"; exit 1;;
          esac

          PAYLOAD="$(php -r 'echo json_encode([
            "release_id" => getenv("RELEASE_ID") ?: "",
            "region" => getenv("REGION") ?: "",
            "locale" => getenv("LOCALE") ?: "",
            "dir_alias" => getenv("DIR_ALIAS") ?: "",
            "probe" => (getenv("PROBE") === "true"),
          ], JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES);')"

          echo "Payload=$PAYLOAD"

          HTTP_RESP="$(curl -sS -X POST "$BASE_URL/api/v0.2/admin/content-releases/rollback" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -H "X-Admin-Token: ${ADMIN_TOKEN}" \
            -d "$PAYLOAD" \
            -w '\n__HTTP_STATUS__:%{http_code}\n')"

          HTTP_STATUS="$(echo "$HTTP_RESP" | sed -n 's/^__HTTP_STATUS__://p')"
          RESP="$(echo "$HTTP_RESP" | sed '/^__HTTP_STATUS__:/d')"

          echo "$RESP" | php -r '
            $raw = stream_get_contents(STDIN);
            $j = json_decode($raw, true);
            if (!is_array($j)) { echo $raw.PHP_EOL; exit(0); }
            echo json_encode($j, JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE).PHP_EOL;
          '

          case "$HTTP_STATUS" in
            2*) ;;
            *) echo "::error::HTTP status=$HTTP_STATUS"; exit 1;;
          esac

          OK="$(echo "$RESP" | php -r '
            $raw=stream_get_contents(STDIN);
            $j=json_decode($raw,true);
            echo (is_array($j) && (($j["ok"] ?? false) === true)) ? "true" : "false";
          ')"
          STATUS="$(echo "$RESP" | php -r '
            $raw=stream_get_contents(STDIN);
            $j=json_decode($raw,true);
            echo is_array($j) ? ($j["status"] ?? "") : "";
          ')"
          MSG="$(echo "$RESP" | php -r '
            $raw=stream_get_contents(STDIN);
            $j=json_decode($raw,true);
            echo is_array($j) ? ($j["message"] ?? "") : "";
          ')"
          ERR="$(echo "$RESP" | php -r '
            $raw=stream_get_contents(STDIN);
            $j=json_decode($raw,true);
            echo is_array($j) ? ($j["error"] ?? "") : "";
          ')"

          [[ "$OK" == "true" ]] || { echo "::error::rollback api failed ok=$OK error=$ERR message=$MSG"; exit 1; }
          [[ "$STATUS" == "success" ]] || { echo "::error::rollback failed status=$STATUS error=$ERR message=$MSG"; exit 1; }

          NEW_RELEASE_ID="$(echo "$RESP" | php -r '$j=json_decode(stream_get_contents(STDIN), true); echo is_array($j) ? ($j["release_id"] ?? "") : "";')"
          RB_VERSION_ID="$(echo "$RESP" | php -r '$j=json_decode(stream_get_contents(STDIN), true); echo is_array($j) ? ($j["rolled_back_to"]["version_id"] ?? "") : "";')"
          RB_PACK_ID="$(echo "$RESP" | php -r '$j=json_decode(stream_get_contents(STDIN), true); echo is_array($j) ? ($j["rolled_back_to"]["pack_id"] ?? "") : "";')"

          echo "rolled_back_release_id=$NEW_RELEASE_ID" >> "$GITHUB_OUTPUT"
          echo "rolled_back_version_id=$RB_VERSION_ID" >> "$GITHUB_OUTPUT"
          echo "rolled_back_pack_id=$RB_PACK_ID" >> "$GITHUB_OUTPUT"

      - name: Post-rollback probes (public)
        env:
          TARGET_ENV: ${{ inputs.target_env }}
          REGION: ${{ inputs.region }}
          LOCALE: ${{ inputs.locale }}
        shell: bash
        run: |
          set -euo pipefail

          case "$TARGET_ENV" in
            production) PUBLIC_BASE="https://fermatmind.com" ;;
            staging) PUBLIC_BASE="https://staging.fermatmind.com" ;;
            *) echo "::error::invalid target_env=$TARGET_ENV"; exit 2;;
          esac

          curl -fsS "$PUBLIC_BASE/api/v0.2/healthz" \
            | php -r '$j=json_decode(stream_get_contents(STDIN), true); exit((($j["ok"] ?? false) === true) ? 0 : 1);' >/dev/null

          curl -fsS "$PUBLIC_BASE/api/v0.2/scales/MBTI/questions?region=${REGION}&locale=${LOCALE}" \
            | php -r '$j=json_decode(stream_get_contents(STDIN), true); exit((($j["ok"] ?? false) === true) ? 0 : 1);' >/dev/null

          curl -fsS "$PUBLIC_BASE/api/v0.2/content-packs" \
            | php -r '$j=json_decode(stream_get_contents(STDIN), true); exit((($j["ok"] ?? false) === true) ? 0 : 1);' >/dev/null
