# 退款与赠送政策（refund & gift policy）

## 定义
- 退款类型：全额退款、部分退款。
- 赠送订单（gifted）：由运营/系统发起的非支付订单。
- 收入口径：赠送不计收入，但计入审计与权益发放。

## 规则
1) 退款分类与状态变化（写死）
- 全额退款：订单状态进入 `refunded`，订单终止，不再发生支付相关流转。
- 部分退款：订单状态进入 `refunded`，标记 `refund_amount` 与 `refund_reason`；订单不再回到 `paid`。

2) 权益撤销策略（写死默认）
- 默认：数字内容不撤销，但必须记录“退款已发生”的审计事件。
- 可选：若产品明确要求，可配置“撤销访问”策略（需额外说明与通知用户）。

3) gifted 规则（写死）
- 来源：运营赠送、活动补偿、客服补发。
- 原因必须可追溯（`gift_reason`）。
- 不计收入，但必须写入审计事件并触发权益发放流程。

## 示例
- 全额退款：订单 `paid` → `refunded`，权益保留，记录退款事件。
- 部分退款：订单 `fulfilled` → `refunded`，权益保留，记录部分退款金额。
- 赠送：创建 `gifted` 订单，直接发放权益并落审计。

## 异常处理
- 重复退款回调：按幂等规则返回已退款结果，不重复记录。
- 退款与发放并发：以退款为最终状态，权益保持“默认不撤销”。

## 验收
- 退款后订单状态为 `refunded`，且不可回退。
- 默认策略下权益仍可访问，但审计记录完整可追溯。
- gifted 订单不计收入但可完整追溯来源与发放记录。
